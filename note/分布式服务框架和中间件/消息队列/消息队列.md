## 消息队列



### 目录

- [什么是消息队列](#什么是消息队列)
- [为什么要使用消息队列？有哪些应用场景？](#为什么要使用消息队列有哪些应用场景)
- [使用消息队列带来哪些问题](#使用消息队列带来哪些问题)
- [消息中间件比较](#消息中间件比较)

### 什么是消息队列

消息（Message）是指在应用间传送的数据。消息可以非常简单，比如只包含文本字符串，也可以更复杂，可能包含嵌入对象。

消息队列（Message Queue）可以理解为存放的消息的容器。消息生产者将消息放入消息队列中，消息消费者从消息队列中取出消息。队列 Queue 是一种先进先出的数据结构，所以消费消息时也是按照这个顺序来消费的。

消息队列是一种应用间的异步协作机制。



### 为什么要使用消息队列？有哪些应用场景？

通过异步处理提高系统性能（削峰、减少响应所需时间），降低系统耦合性。



#### 异步处理

发送者将消息发送给消息队列之后，不需要同步等待消息接收者处理完毕，而是立即返回进行其它操作。消息接收者从消息队列中订阅消息之后异步处理。

**减少系统响应时间，提高吞吐量。**

场景例如：**短信通知**、**终端状态推送**、**APP 推送**、**用户注册** 等。

例如在注册流程中通常需要发送验证邮件来确保注册用户身份的合法性，可以使用消息队列使发送验证邮件的操作异步处理，用户在填写完注册信息之后就可以完成注册，而将发送验证邮件这一消息发送到消息队列中。

只有在业务流程允许异步处理的情况下才能这么做，例如上面的注册流程中，如果要求用户对验证邮件进行点击之后才能完成注册的话，就不能再使用消息队列。



####应用解耦

通过一个 MQ，使用 **Pub / Sub 发布-订阅模式**，消息生产者发布消息，一个或多个消息消费者订阅消息，应用之间没有直接关联，达到应用解耦的目的。



####流量削峰 

在高并发的场景下，如果短时间有大量的请求到达，数据库压力剧增，使得响应速度变慢，甚至会压垮服务器。可以将请求发送到消息队列中，服务器按照其处理能力从消息队列中订阅消息进行处理。



比如，秒杀活动，一般会因为瞬时流量过大，导致应用挂掉，可以加入消息队列。服务器收到用户请求后，首先写入消息队列，加入消息队列请求数超过最大值，则直接抛弃用户请求或跳转到错误页面。秒杀业务根据消息队列中的请求信息，再做后续处理。可以缓解短时间的高流量压垮应用。

双十一活动中，下单成功后需要发送短信通知下单成功，一时间有大量的短信需要发送，短信系统一时处理不过来。 用户晚个半分钟左右收到短信，一般是不会有太大问题。所以可以将短信发送请求放到消息队列中，待高峰期过期，慢慢消费积压在消息队列中的短信。



#### 日志处理

将消息队列用在日志处理中，比如 Kafka 的应用，解决海量日志传输和缓冲的问题。



#### 消息通讯

消息队列一般都内置了 **高效的通信机制**，因此也可以用于单纯的 **消息通讯**，比如实现 **点对点消息队列** 或者 **聊天室** 等。



### 使用消息队列带来哪些问题？

让系统可用性降低、复杂度提高，另外需要保障一致性等问题。

- **系统可用性降低**：系统引入的外部依赖越多，越容易挂掉。本来你就是 A 系统调用 BCD 三个系统的接口就好了，人 ABCD 四个系统好好的，没啥问题，你偏加个 MQ 进来，万一 MQ 挂了咋整，MQ 一挂，整套系统崩溃的，你不就完了？如何保证消息队列的高可用，可以[点击这里查看](https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/how-to-ensure-high-availability-of-message-queues.md)。
- **系统复杂性提高**：加入 MQ 之后，需要保证消息没有被重复消费，处理消息丢失的情况，保证消息传递的顺序性等等问题。
- **一致性问题**：A 系统处理完了直接返回成功了，但是后续在其他系统中的操作可能失败了，这就产生不一致。



### 消息中间件比较

| 特性                     | ActiveMQ                              | RabbitMQ                                           | RocketMQ                                                     | Kafka                                                        |
| ------------------------ | ------------------------------------- | -------------------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 单机吞吐量               | 万级，比 RocketMQ、Kafka 低一个数量级 | 同 ActiveMQ                                        | 10 万级，支撑高吞吐                                          | 10 万级，高吞吐，一般配合大数据类的系统来进行实时数据计算、日志采集等场景 |
| topic 数量对吞吐量的影响 |                                       |                                                    | topic 可以达到几百/几千的级别，吞吐量会有较小幅度的下降，这是 RocketMQ 的一大优势，在同等机器下，可以支撑大量的 topic | topic 从几十到几百个时候，吞吐量会大幅度下降，在同等机器下，Kafka 尽量保证 topic 数量不要过多，如果要支撑大规模的 topic，需要增加更多的机器资源 |
| 时效性                   | ms 级                                 | 微秒级，这是 RabbitMQ 的一大特点，延迟最低         | ms 级                                                        | 延迟在 ms 级以内                                             |
| 可用性                   | 高，基于主从架构实现高可用            | 同 ActiveMQ                                        | 非常高，分布式架构                                           | 非常高，分布式，一个数据多个副本，少数机器宕机，不会丢失数据，不会导致不可用 |
| 消息可靠性               | 有较低的概率丢失数据                  | 基本不丢                                           | 经过参数优化配置，可以做到 0 丢失                            | 同 RocketMQ                                                  |
| 功能支持                 | MQ 领域的功能极其完备                 | 基于 erlang 开发，并发能力很强，性能极好，延时很低 | MQ 功能较为完善，还是分布式的，扩展性好                      | 功能较为简单，主要支持简单的 MQ 功能，在大数据领域的实时计算以及日志采集被大规模使用 |



总结：

- ActiveMQ 性能比较差，而且版本迭代很慢，不推荐使用。
- RabbitMQ 在吞吐量方面虽然稍逊于 Kafka 和 RocketMQ ，但是由于它基于 erlang 开发，所以并发能力很强，性能极其好，延时很低，达到微秒级。而且社区活跃度较高，一般不会黄。对于中小型公司，技术实力较为一般，业务场景对并发量要求不是太高（十万级、百万级）的，推荐用 RabbitMQ。
- RocketMQ 阿里出品，Java 系开源项目，可以定制自己公司的 MQ，并且 RocketMQ 有阿里巴巴的实际业务场景的实战考验。但 RocketMQ 社区活跃度相对较为一般。对自己公司技术实力有绝对自信的，推荐用 RocketMQ。
- kafka 的特点其实很明显，就是仅仅提供较少的核心功能，但是提供超高的吞吐量，ms 级的延迟，极高的可用性以及可靠性，而且分布式可以任意扩展。同时 kafka 最好是支撑较少的 topic 数量即可，保证其超高吞吐量。kafka 唯一的一点劣势是有**可能消息重复消费**，那么对数据准确性会造成极其轻微的影响，在大数据领域中以及日志采集中，这点轻微影响可以忽略。因此 Kafka 适合大数据实时计算以及日志收集的场景。



参考：

- [为什么使用消息队列？消息队列有什么优点和缺点？Kafka、ActiveMQ、RabbitMQ、RocketMQ 都有什么优点和缺点？](https://github.com/doocs/advanced-java/blob/master/docs/high-concurrency/why-mq.md)