## RabbitMQ 消息重复消费



### 什么情况下消息会重复消费？

- 由于网络或其他原因 RabbitMQ 没有收到消费者发来的 ACK ，那么 RabbitMQ 不会将消息删除。在重新建立连接之后，消费者还会消费到这一条消息，这就造成消息重复消费。
- 生产者在使用 publisher confirm 机制时，发送完一条消息等待 RabbitMQ 返回 ACK，此时网络断开，生产者捕获到异常情况，然后重新发送消息，这样 RabbitMQ 中就有两条一样的消息，在消费的时候就重复消费。



### 如何避免消息重复消费？

目前大多数主流的消息中间件都没有消息去重机制，去重处理一遍在业务客户端实现。

- 业务操作保证幂等性，比如插入时间前先 select 一下
- 借住 Redis 去重，每次都是 set，天然幂等性。
- 基于数据库的唯一键来保证重复数据不会重复插入多条。

