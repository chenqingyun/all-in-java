## SQL 语句为什么变慢了

一条 SQL 语句，正常执行的时候特别快，但是有时候却特别慢，怎么回事？

InnoDB 在处理更新语句的时候先写 redo log，并更新到内存。然后在合适的时间刷新到磁盘里，这个操作称为「 flush 」。[日志模块：一条 SQL 更新语句如何执行](https://github.com/chenqingyun/all-in-java/blob/master/note/%E6%95%B0%E6%8D%AE%E5%BA%93/MySQL/MySQl%20%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F%EF%BC%9A%E4%B8%80%E6%9D%A1%20SQL%20%E6%9B%B4%E6%96%B0%E8%AF%AD%E5%8F%A5%E6%98%AF%E5%A6%82%E4%BD%95%E6%89%A7%E8%A1%8C%E7%9A%84.md)



当内存数据页跟磁盘数据页内容不一致的时候，我们称这个内存页为「 脏页 」。内存数据写入到磁盘后，内存和磁盘上的数据页的内容就一致了，称为「 干净页 」。

**SQL 执行很慢，有可能是在刷脏页（flush）**。

什么情况会引发数据库的 flush 过程呢？

- **redo log 写满**。这时候系统会停止所有更新操作，空出位置，将原来位置上的脏页都 flush 到磁盘上，然后就就可以在空出的位置上写入日志了。
- **内存不足**。当需要新的内存页的时候，而内存不够用，就要淘汰一些数据页，空出内存给新的数据页用。如果是脏页，还要把脏页的内容写入磁盘。
- 系统空闲时刷脏页。这个不会对性能造成影响。
- MySQL 正常关闭时。这个也不会对性能造成影响。



造成性能的问题是前两种场景：

第一种是 「 redo log 写满了，要 flush 脏页 」，这种情况是 InnoDB 要尽量避免的。因为出现这种情况的时候，整个系统就不能再接受更新了，所有的更新都必须堵住。如果从监控上看，这时候更新数会跌为 0。

第二种是「 内存不够用了，要先将脏页写到磁盘 」，这种情况其实是常态。



如何解决：

- redo log 内存设大点。

- InnoDB 脏页的控制策略。合理地设置 innodb_io_capacity 参数，平时要多关注脏页比例，不要让它经常接近 75%。

  

[MySQL 实战 45 讲 - 为什么我的MySQL会“抖”一下？](https://time.geekbang.org/column/article/71806)
