## 事务

在 MySQL 中，事务是在引擎层实现的。

### ACID

- 原子性
- 一致性
- 隔离性
- 持久性



### 隔离级别

隔离级别越低，并发性能越高，系统的开销越低。

- **READ UNCOMMITED (读未提交)**

  - 可以读取未提交事务的修改，这也被称为「 脏读 ( Dirty Read) 」。

  - 隔离级别最低，并发性能高。但性能也不会比其他级别好太多，还会带来很多问题。实际很少使用这个隔离级别。

  - 导致问题：脏读、不可重复读、幻读。

    > **不可重复读 Nonrepeatable Read** ：在同一个事务内执行两次相同的查询，可能会得到不一样的结果。
    >
    > **幻读 Phantom Read：**当某个事务读取了某个范围的记录时，另一个事务又在该范围内插入一行数据，当之前的事务再次读取该范围的记录时，会产生幻行。（就好像是幻觉一样，咦，怎么多了一行记录）InnoDB 通过多版本并发控制 ( MVCC ) 解决幻读问题。

- **READ COMMITED (读已提交)**

  - 直到事务提交了对其他事务才可见。
  - 导致问题：不可重复读、幻读。

- **REPEATABLE READ (可重复读)**

  - 保证在同一个事务中多此读取同样记录的结果是一致的。
  - 可解决脏读、不可重复读，未能解决幻读。
  - MySQL 默认事务隔离级别

- **SERIALIZABLE (可串行化)**

  - 隔离级别最高。实际很少使用。

  - 会在读取的每一行上加锁，所以会导致大量的超时和锁争用问题

  - 通过强制事务串行执行，避免幻读。

    

<img width="551" alt="MySQL 事务隔离级别" src="https://user-images.githubusercontent.com/19634532/58936111-91604280-87a1-11e9-80b7-1c41fbeeb88f.png">



### 事务隔离的实现

每条记录在更新的时候都会同时在 undo log ( 回滚日志 ) 中记录一个回滚操作。

**尽量不要使用长事务。**

在 MySQL 5.5 及以前的版本，回滚日志是跟数据字典一起放在 ibdata 文件里的，即使长事务最终提交，回滚段被清理，文件也不会变小。

除了对回滚段的影响，长事务还占用锁资源，也可能拖垮整个库。



[MySQL 实战45 事务隔离：为什么你改了我还看不见？](https://time.geekbang.org/column/article/68963)

