## Redis 事务

相关命令：

- 「 MULTI 」 命令指示事务的开始
- 「 EXEC 」命令指示将事务提交给服务器执行
- 「 DISCARD 」命令执行事务的丢弃



#### 事务的实现

三个阶段：

- 事务开始
- 命令入队
- 事务执行



所有指令在 EXEC 之前不执行，先缓存在服务器的一个事务队列中，一旦收到 EXEC 指令才开始按先进先出（FIFO）的顺序执行事务队列，执行完毕后一次性返回所有指令的允许结果。



### 事务中的错误

- 命令错误：如果是命令错误，服务器会对命令入队失败的情况进行记录，并在客户端调用 EXEC 命令时，拒绝执行并自动放弃这个事务，后面的命令不会执行。

- 运行错误：即使事务中有某个/某些命令在执行时产生了错误， 事务中的其他命令仍然会继续执行。



Redis 保证了事务中 ACID 的原子性（A）、隔离性（I）和持久性（D）。

> 严格来说，事务中的命令如果处理了错误类型的键，执行将产生错误，后面的命令仍然会继续执行，这将不保证原子性。

### watch 机制

使用 「 WATCH 」命令，它是一种乐观锁，可以为 Redis 事务提供 check-and-set （CAS）行为。

可以在 EXEC 命令之前监视一个或多个数据库键，检查被监视的键是否至少有一个被修改或删除，如果是，服务器拒绝执行事务，并返回 NULL 告知客户端事务执行失败。



注意：

WATCH 命令要在 MULTI 命令之前执行。



相关文章：

[Redis 事务](http://redisdoc.com/topic/transaction.html)
