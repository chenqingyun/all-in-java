## Redis 持久化机制



### 目录

- [RDB 原理](#rdb-原理)
- [AOF 原理](#aof-原理)
- [混合持久化](#混合持久化)



Redis 持久化机制有两种：

- RDB 快照：全量备份。
- AOF 日志：增量备份。



Redis 默认使用 RDB 文件快照的形式进行持久化。两种持久化方式可以单独使用，也可以同时使用。如果配置使用了 AOF 持久化功能，服务器会优先使用 AOF 文件来还原数据库状态。

### RDB 原理

快照持久化方式，可以将存在于某一时刻的数据都写入到硬盘中。

RDB 持久化功能所生成的 RDB 文件是一个经过压缩的二进制文件，在存储上非常紧凑。

创建 RDB 文件的有以下几种方式：

- 使用 「 SAVE 」命令：该命令会阻塞 Redis 服务器进程，服务器不能处理任何命令请求，知道 RDB 文件创建完成。
- 使用 「 BGSAVE」命令：触发该命令，Redis 会使用操作系统的 「 多进程 COW （Copy On Write）」机制来实现快照持久化。Redis 会调用操作系统的 「 fork 」产生一个子进程，子进程负责完成快照持久化，服务器进程（父进程）继续处理命令请求。
- 在配置文件中「 配置 SAVE 选项 」。如配置 「 save 60 100 」表示 60 秒内有 100 次写入就会触发 Redis 的 BGSAVE 命令。
- 当 Reids 接收到 「 SHUTDOWN 」关闭服务器的请求命令命，或者接收到标准的 TIME 信号时，会先执行 SAVE 命令，阻塞所有客户端，不再执行客户端发出的命令，待 SAVE 命令执行完毕，再关闭服务器。
- 当一个 Redis 服务器连接另一个 Redis 服务器，并发送 「 SYNC 」命令来开始一次复制时，若主服务器没有在执行 BGSAVE 命令，且也没有刚执行过 BGSAVE 命令，那么主服务器会执行 BGSAVE 命令。



服务器在载入 RDB 文件时会处于阻塞状态，直到载入完成。



优点：

- 保存了某个时间点的 Redis 数据，适合用于灾备。
- 比起 AOF ，在数据量大的情况下，RDB 的启动速度更快。



缺点：

- 系统崩溃将会丢失上次快照之后的数据。
- 如果数据较大将会影响性能。



### AOF 原理

AOF (Append Only File) 持久化，只追加式文件持久化。AOF 持久化是将 Redis 服务器所执行的写命令保存到 AOF 日志中。**当 Redis 服务器重启时会载入和执行保存在 AOF 日志文件中的命令来还原服务器关闭之前的数据**。**所以 AOF 主要就是解决持久化的实时性**。



#### AOF 实现

AOF 持久化功能的实现分为「 命令追加 ( append)  」，「 文件写入 」，「 文件同步 ( sync ) 」三个步骤。

1. 命令追加： Redis 服务器在收到客户端的写命令时，会先执行命令，再将写命令追加到服务器的 aof_buf 缓冲区末尾。

2. 将 aof_buf 缓冲区的内容写入和保存到 AOF 文件中。通过配置 「 appendfsync 」选项来配置 AOF 文件同步频率
   - appendfsync always：每个 Redis 写命令都写入和同步到 AOF 文件。可以将数据丢失减少到最少，但会严重降低 Redis 的速度。
   - appendfsync everysec：将 aof_buf 缓冲区中的所有内容写入到 AOF 文件，但是每秒执行一次同步，并且这个同步操作是由一个线程专门负责的。这种策略最多只会丢失一秒之内产生的数据，一般使用这种策略。
   - appendfsync no：所有写命令写入到 AOF 文件，但不对 AOF 文件进行同步，何时同步由操作系统决定。这种同步方式一般不会对 Redis 性能造成影响，但系统崩溃会导致 Redis 服务器丢失不定数量的数据。另外，如果缓冲区被写满，将会阻塞 Redis 写入操作，并导致 Redis 处理命令请求的速度变慢。



优点：

- 比 RDB 可靠。可以每秒执行一次 AOF 同步，这意味着你最多丢失一秒钟的数据。
- 当 AOF 文件太大时，Redis 会自动在后台进行重写。
- AOF 把操作命令以简单易懂的格式一条接一条的保存在文件里，很容易导出来用于恢复数据。



缺点：

- 在相同的数据集下，AOF 文件的大小一般会比 RDB 文件大。
- 在某些 fsync 策略下，AOF 的速度会比 RDB 慢。





#### 重写/压缩 AOF 文件

随着服务器运行时间的增长，AOF 文件的内容会越来越多，文件体积越来越大，Redis 在重启时载入和执行 AOF 文件中命令来还原数据就需要很长时间。

Redis 提供了「 BGREWRITEAOF 」命令，这个命令会通过移除 AOF 文件中冗余的命令来重写 AOF 文件，使得 AOF 文件体积变得尽可能小。

其原理同 BGSAVE 命令原理相识，就是创建一个子进程，子进程负责对 AOF 文件进行重写。

具体过程就是：子进程将数据重新写入一个新的 AOF 文件中，在重写期间，服务器进程（父进程）继续处理命令请求。为了解决数据不一致，Redis 设置了一个 「 AOF 重写缓冲区 」。当子进程创建后，缓冲区开始使用，当 Reids 服务器执行完一个写命令后，会同时将命令写入 AOF 缓冲区和 AOF 重写缓冲区。在子进程完成 AOF 文件重写后，会向父进程发送一个信号，父进程在接收到信号后会调用一个信号处理函数，将 AOF 重写缓冲区的内容写入到新的 AOF 文件中，然后删除旧的 AOF 文件用新的替换，至此 AOF 文件重写操作完成。在信号处理函数执行完毕之后，父进程继续接受命令请求。

在整个 AOF 文件重写过程中，只有信号处理函数执行时父进程会阻塞，其他时候 AOF 重写都不会造成父进程阻塞。



相关文章：

- [Redis持久化](https://segmentfault.com/a/1190000002906345)
- [一文看懂Redis的持久化原理](https://juejin.im/post/5b70dfcf518825610f1f5c16#heading-5)





###  Redis 启动时如何恢复数据？

启动时会先检查 AOF 文件是否存在，如果不存在就尝试加载 RDB。

**那么为什么会优先加载AOF呢？**

因为 AOF 保存的数据更完整，我们知道 AOF 基本上最多损失 1s 的数据。



### 混合持久化

重启 Redis 时，很少使用 RDB 开恢复数据，因为会丢失量数据。通常使用 AOF 日志重放，但是重放 AOF 日子会比使用 RDB 慢很多。Redis 4.0 带来了一个新的持久化方案——「 混合持久化 」。

将 RDB 文件的内容和增量的 AOF 日志文件放在一起。这里的 AOF 日志文件是增量的数据，是从持久化开始到持久化结束这段时间发生的增量数据，通常这部分 AOF 日志较小。

在 Redis 重启的时候，先加载 RDB 的内容，然后再重放增量 AOF 日志，重启效率提高。



### 参考

- 《Redis 设计与实现 第二版》黄建宏 著

- 《Redis 实战》Josiah L. Carlson 著

- 《Redis 深度历险 核心原理与应用实践》钱文品 著

- [一文看懂Redis的持久化原理](https://juejin.im/post/5b70dfcf518825610f1f5c16)